name: Deploy to Google Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: bloomium
  REGION: us-central1
  GCS_BUCKET: bloomium-tiles

jobs:
  # Build all images in parallel
  build-images:
    name: Build All Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    strategy:
      matrix:
        service: [api, web, worker]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io

      - name: Build and Push ${{ matrix.service }} image
        run: |
          docker build \
            -f apps/${{ matrix.service }}/Dockerfile \
            -t gcr.io/${{ env.PROJECT_ID }}/bloomium-${{ matrix.service }}:${{ github.sha }} \
            -t gcr.io/${{ env.PROJECT_ID }}/bloomium-${{ matrix.service }}:latest \
            .
          docker push gcr.io/${{ env.PROJECT_ID }}/bloomium-${{ matrix.service }}:${{ github.sha }}
          docker push gcr.io/${{ env.PROJECT_ID }}/bloomium-${{ matrix.service }}:latest

  # Deploy API first (Web depends on API URL)
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: build-images
    permissions:
      contents: read
      id-token: write
    outputs:
      api_url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy API to Cloud Run
        id: deploy
        run: |
          gcloud run deploy bloomium-api \
            --image=gcr.io/${{ env.PROJECT_ID }}/bloomium-api:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --set-env-vars="MODE=cloud,GCS_BUCKET=${{ env.GCS_BUCKET }},GCP_PROJECT_ID=${{ env.PROJECT_ID }},GCP_REGION=${{ env.REGION }},API_PORT=8080" \
            --memory=1Gi \
            --cpu=1 \
            --timeout=60s \
            --min-instances=0 \
            --max-instances=10
          
          API_URL=$(gcloud run services describe bloomium-api \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$API_URL" >> $GITHUB_OUTPUT

  # Deploy Web and Worker in parallel
  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: deploy-api
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Web to Cloud Run
        run: |
          gcloud run deploy bloomium-web \
            --image=gcr.io/${{ env.PROJECT_ID }}/bloomium-web:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=3000 \
            --set-env-vars="NEXT_PUBLIC_API_URL=${{ needs.deploy-api.outputs.api_url }}" \
            --memory=512Mi \
            --cpu=1 \
            --timeout=60s \
            --min-instances=0 \
            --max-instances=10

  deploy-worker:
    name: Deploy Worker
    runs-on: ubuntu-latest
    needs: build-images
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Update Worker Job
        run: |
          gcloud run jobs update bloomium-worker \
            --image=gcr.io/${{ env.PROJECT_ID }}/bloomium-worker:${{ github.sha }} \
            --region=${{ env.REGION }} || \
          gcloud run jobs create bloomium-worker \
            --image=gcr.io/${{ env.PROJECT_ID }}/bloomium-worker:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --set-env-vars="MODE=cloud,GCS_BUCKET=${{ env.GCS_BUCKET }},GCP_PROJECT_ID=${{ env.PROJECT_ID }},STORAGE_PATH=gs://${{ env.GCS_BUCKET }}" \
            --memory=2Gi \
            --cpu=2 \
            --max-retries=3 \
            --task-timeout=30m

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web, deploy-worker]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result == 'success' && 'âœ…' || 'âŒ' }} | \`bloomium-api\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.deploy-web.result == 'success' && 'âœ…' || 'âŒ' }} | \`bloomium-web\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ needs.deploy-worker.result == 'success' && 'âœ…' || 'âŒ' }} | \`bloomium-worker\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-api.result }}" == "success" ] && \
             [ "${{ needs.deploy-web.result }}" == "success" ] && \
             [ "${{ needs.deploy-worker.result }}" == "success" ]; then
            echo "### âœ… All deployments successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Web App:** https://bloomium-web-569323643033.us-central1.run.app" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”Œ **API:** https://bloomium-api-569323643033.us-central1.run.app" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some deployments failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

